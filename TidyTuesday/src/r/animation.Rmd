---
title: "Animation"
author: "bokola"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r paths, warning=FALSE, message=FALSE, results='hide'}
# Set project path
rm(list=ls(all.names = T))
home.dir <- ifelse(Sys.info()["sysname"] == "Windows", Sys.getenv("USERPROFILE"), Sys.getenv("HOME"))
m.project.path <- path.expand(file.path(home.dir
                                        ,"Analysis"
                                        ,"TidyTuesday"
                                        ))

m.project.path <- gsub("\\\\","/",m.project.path)
if(!file.exists(m.project.path)) {
  if(dir.create(m.project.path, recursive = TRUE))
    stop("The project directory \""
         ,m.project.path
         ,"\"  has been created!\nPlease fill it with the relevant files and folders!")
  else
    stop("The project directory \""
         ,m.project.path
         ,"\"  could not be created!")
}

# Set relevant Directories

# Reporting directory
 report.location = file.path(m.project.path, "cache", "doc", "animation")
 if(!file.exists(report.location)) {
   if(dir.create(report.location, recursive = TRUE))
     stop("The project directory \""
          ,report.location
          ,"\"  has been created!\nPlease fill it with the relevant files and folders!")
   else
     stop("The project directory \""
          ,report.location
          ,"\"  could not be created!")
 }
# scripts directory
 
 scripts_location <- file.path(m.project.path, 'src', 'r')
 if(!file.exists(scripts_location)) {
   if(dir.create(scripts_location, recursive = T))
     stop('The script directory \''
          , scripts_location
          , '\' has been created!\nPlease fill it with relevant files and folders!')
   else
     stop('The script directory \''
          ,scripts_location
          ,'\' could not be created!')
 }
```

Animation is helpful when visualizing changes over time, changes over iterative/recursive techniques (like gradient descent or bellman equations), changes during a simulation.
The key point is to highlight important changes in the data over the variable that is driving the animation

```{r packages, results='hide', warning=FALSE, message=FALSE}
ipk = function(pkg){
  new.pkg = list.of.pkgs[!(list.of.pkgs %in% installed.packages()[, 'Package'])]
  if(length(new.pkg)) install.packages(new.pkg, dep = T)
  sapply(pkg, require, character.only = T)
  
}
list.of.pkgs = c("animation", "gganimate", "plotly","dplyr","ggplot2" , "plyr", "gapminder","animation", "rust", "datasauRus", "Hmisc", "geonames", "cowplot", "ggpubr", "ggthemes", "stringr", "tidyverse")
ipk(list.of.pkgs)

```
Data

```{r data, results='hide', warning=FALSE, message=FALSE}
coast_vs_waste <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-05-21/coastal-population-vs-mismanaged-plastic.csv") %>% janitor::clean_names()
mismanaged_vs_gdp <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-05-21/per-capita-mismanaged-plastic-waste-vs-gdp-per-capita.csv" ) %>% janitor::clean_names()
waste_vs_gdp <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-05-21/per-capita-plastic-waste-vs-gdp-per-capita.csv") %>% janitor::clean_names() 
waste_vs_gdp = waste_vs_gdp %>% dplyr::rename(., gdp_per_capita_ppp_constant_2011_international_rate = gdp_per_capita_ppp_constant_2011_international_constant_2011_international)
plastic_data = merge(coast_vs_waste, waste_vs_gdp, all = T) %>% 
  merge(., mismanaged_vs_gdp, all = T) %>% 
  mutate(., decade = year - (year %% 10)) %>% 
  dplyr::rename(country = entity)

data = plastic_data %>% 
  subset(., !is.na(year)&!is.na(total_population_gapminder)) %>%  group_by(country) %>% 
  mutate(., pop.growth = (total_population_gapminder -lag(total_population_gapminder))/lag(total_population_gapminder)) %>% 
  mutate(., pop.growth = ifelse(is.na(pop.growth), 0, pop.growth))  %>% 
  mutate(., pop.growth = round(pop.growth*100, 0)) %>%  ungroup() %>% 
  select(country, code, year, total_population_gapminder, pop.growth, everything()) %>% 
  subset(., year >= 1900) %>% arrange(., country, year) 
  
```
First is the `animation` library
```{r, animate}
desc = c("This is a super cool example of Gradient Descent")

saveHTML({

  f1 = function(x, y) x^2 + 3 * sin(y)
  xx = grad.desc(f1, pi * c(-2, -2, 2, 2), c(-2 * pi, 2))
 
 xx$persp(col = "lightblue", theta = 30, phi = 30)

},title = "Demo of Gradient Descent", description = desc, verbose = FALSE)
```
`gganimate`
```{r gganimate}
library(datasauRus)

ggplot(datasaurus_dozen, aes(x=x, y=y))+
  geom_point()+
  theme_minimal() +
  transition_states(dataset, 3, 1) + 
  ease_aes('cubic-in-out')
```
`plotly`
```{r plotly}
library(plotly)
library(gapminder)

p <- gapminder %>%
  plot_ly(
    x = ~gdpPercap, 
    y = ~lifeExp, 
    size = ~pop, 
    color = ~continent, 
    frame = ~year, 
    text = ~country, 
    hoverinfo = "text",
    type = 'scatter',
    mode = 'markers'
  ) %>%
  layout(
    xaxis = list(
      type = "log"
    )
  )
p
```
Animated bar graphs. We use `ggplot2` and `gganimate` packages

```{r animated_bars}
library(tidyverse)
library(gganimate)


europe <- c("Argentina", "Bolivia", "Brazil", "Chile", "Colombia", "Ecuador", "Guyana", "Paraguay", "Peru", "Suriname", "Uruguay", "Venezuela")

europe <- sort(europe, decreasing = TRUE)

pop_formatted <- data %>%
  group_by(year) %>%
  # The * 1 makes it possible to have non-integer ranks while sliding
  mutate(rank = rank(-total_population_gapminder),
         Value_rel = total_population_gapminder/total_population_gapminder[rank==1], # pop relative to most populous
         Value_lbl = paste0(" ",round(total_population_gapminder/1e6))) %>%
  group_by(country) %>% 
  filter(rank <=10) %>%
  ungroup()
max_value = round(max(pop_formatted$total_population_gapminder)/1e6)
min_value = round(min(pop_formatted$total_population_gapminder)/1e6)
# Animation

#gdp_formatted <- readr::read_csv("https://raw.githubusercontent.com/amrrs/animated_bar_charts_in_R/master/data/gdp_tidy.csv")
# anim <- ggplot(pop_formatted, aes(rank, group = country, 
#                                   fill = 'skyblue', color = 'skyblue')) +
#   geom_tile(aes(y = total_population_gapminder,
#                 height = total_population_gapminder,
#                 width = 0.9), alpha = 0.8, color = "skyblue") +
anim <- ggplot(pop_formatted) + 
  geom_bar(aes(Country, Mortality), fill = "skyblue",  stat = "identity") +
  coord_flip(clip= "off") +
    theme_minimal(base_size = 6)+
    labs(x = NULL, y = NULL) +
    labs(caption = "Data source: Our World in Data", title = "The decline of infant mortality in South America")+
    labs(subtitle = "Pop in millions")+
    geom_text(x = 13, y = max_value * 0.93, label = year, size = 3.5) +
    theme(panel.grid.major.y = element_blank())+
    theme(panel.grid.minor.y = element_blank())+
    theme(panel.grid.minor.x = element_blank())+
    # geom_text(data = fuel_pc, aes(x = Fuel, y = fuel,  label = Percentage), hjust = 0)+
    # geom_text(data = yy_rank, aes(x = Rank, y = -0.01 * max_value, label = Fuel), hjust = 1) +
    scale_y_continuous(limits = c(0, max_value), labels = labels, breaks = breaks, expand = c(0,0)) +
    theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm")) +
    labs(fill = NULL) +
    theme(legend.position = "none")+
    theme(plot.title = element_text(face = "bold"))+
    theme(plot.margin=grid::unit(c(1,1,1,1), "mm"))

# For GIF

animate(anim, 200, fps = 20,  width = 1200, height = 1000, 
        renderer = gifski_renderer("gganim.gif")) 

# For MP4

animate(anim, 200, fps = 20,  width = 1200, height = 1000, 
        renderer = ffmpeg_renderer()) -> for_mp4

anim_save("animation.mp4", animation = for_mp4 )
```